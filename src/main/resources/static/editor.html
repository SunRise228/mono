<!DOCTYPE html>
<html>
<head>

    <style>
.editor {
  padding: 10px;
  margin: 10px;
  outline: none;
}

.token-variable {
  color: blue;
}

.token-field {
  color: #842;
}

.token-mask {
  color: gray;
}

.token-string {
  color: green;
}

.token-number {
  color: green;
}

.token-comparator {
  color: #0e4;
}

.token-parentheses {
  color: red;
}

.token-operators {
  color: black;
}
</style>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>

var waitOn = false;
const collection = [' ', ',', '.', '(', ')', '{', '}', '+', '-', '/', '*'];
var keydown = false;

$(document).ready(function(){
    var editor = $("#editorId");
    var editorElement = document.getElementById("editorId");
    var hiddenEditorElement = document.getElementById("hiddenEditorId");
    var program = "if \n ( A1 > 1000 or S1 > 1000 * 6 ) and \n ( PRODUCT_TYPE ='21vek' or ACCOUNT ~ /3012*/ ) { return REJECT; }";
    var html;


    editorElement.addEventListener('keydown', function() {
        keydown = true;
        console.log("keydown = true");
    });


    let timerId = setInterval(() => {

            program = editorElement.innerText;
            html = editorElement.innerHTML;
/*
            var editor = document.createElement("div");
            html = html.replace('<br>', '<br>\n');
            editor.innerHTML = html;
            hiddenEditorElement.innerHTML = html;
                            console.log(editorElement.innerText);
                            console.log(editor.innerText);
                            console.log(editorElement.textContent);
                            console.log(editor.textContent);
                            console.log(editorElement.innerHTML);
                            console.log(editor.innerHTML);
*/
            const init = {
                body: program,
                method: 'POST',
                headers: {
                    'content-type': 'application/json;charset=UTF-8',
                },
            };

            //let offset = getCaret(editorElement);
            //console.log('data', html, offset);
            //setCaret(editorElement, offset.start, offset.end);
            //getPos();

            keydown = false;

            fetch('/html', init)
                .then(function (response) {
                    response.text().then(function (data) {

                        data = data.replaceAll('\n', '');

                        console.log('data', data)
                        hiddenEditorElement.innerHTML = data;

                        if (hiddenEditorElement.textContent == editorElement.textContent) {

                            let offset = getCaret(editorElement);
                            editorElement.innerHTML = data;
                            setCaret(editorElement, offset.start, offset.end);

                            editorElement.focus();
                        }
                        else {
                            console.log(editorElement.innerText);
                            console.log(hiddenEditorElement.innerText);
                            console.log(editorElement.innerHTML);
                            console.log(hiddenEditorElement.innerHTML);
                        }
                    });
                })
                .catch(function() {
                });

    }, 3000);



    $("button").click(function(){

        $.post( 'http://localhost:8099/integration/api/la/dictionary/afm/html', program).done(function( data ) {
            console.log(data);
        });

   });


function pathFromNode(node, reference) {
  function traverse(node, acc) {
    if (node === reference) {
      return acc;
    } else {
      const parent = node.parentNode;
      const index = [...parent.childNodes].indexOf(node);
      return traverse(parent, [index, ...acc]);
    }
  }
  return traverse(node, []);
}

function nodeFromPath(path, reference) {
  if (path.length === 0) {
    return reference;
  } else {
    const [index, ...rest] = path;
    const next = reference.childNodes[index];
    return nodeFromPath(rest, next);
  }
}

function getCaret(el) {
  const range = document.getSelection().getRangeAt(0);
  return {
    start: {
      container: pathFromNode(range.startContainer, el),
      offset: range.startOffset
    },
    end: {
      container: pathFromNode(range.endContainer, el),
      offset: range.endOffset
    }
  };
}

function setCaret(el, start, end) {
  const range = document.createRange();
  range.setStart(nodeFromPath(start.container, el), start.offset);
  range.setEnd(nodeFromPath(end.container, el), end.offset);
  sel = document.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

function update() {
  const pos = getCaret($el);
  $startContainer.value = JSON.stringify(pos.start.container);
  $startOffset.value = pos.start.offset;
  $endContainer.value = JSON.stringify(pos.end.container);
  $endOffset.value = pos.end.offset;
}



});
</script>
</head>
<body>

<button>Send an HTTP POST request to a page and get the result back</button>

<div id="editorId" contenteditable="true" spellcheck="false" class="editor"><span style="color: red;">A1</span><div><br></div><div><br></div><div><br></div>&nbsp; <span style="color: red;">A1</span><div><br></div><span style="color: red;">S1</span></div>
<div id="hiddenEditorId" contenteditable="true" hidden></div>


</body>
</html>
